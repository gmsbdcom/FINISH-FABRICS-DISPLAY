<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8">
    <title>FINISH FABRICS MCD  RACK DISPLAY</title>
    

  </head>
    
  <body>
  <!doctype html>
<html lang="en">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FIMS Mobile Control System</title>
  <script src="/_sdk/element_sdk.js"></script>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
        body {
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }

        .inventory-card {
            transition: all 0.3s ease;
            transform: scale(1);
        }

        .inventory-card:hover {
            transform: scale(1.02);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .inventory-card:hover .card-buttons {
            opacity: 1;
        }

        .card-buttons {
            opacity: 0.7;
            transition: opacity 0.3s ease;
        }

        .highlighted {
            animation: highlight 2s ease-in-out infinite;
            border: 4px solid #f59e0b !important;
            box-shadow: 0 0 30px rgba(245, 158, 11, 0.8) !important;
            transform: scale(1.05) !important;
        }

        @keyframes highlight {
            0%, 100% { 
                border-color: #f59e0b;
                box-shadow: 0 0 30px rgba(245, 158, 11, 0.8);
            }
            50% { 
                border-color: #fbbf24;
                box-shadow: 0 0 40px rgba(251, 191, 36, 1);
            }
        }

        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .mode-indicator {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 12px;
            color: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .user-mode { background: linear-gradient(135deg, #10b981, #059669); }
        .controller-mode { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
        .display-mode { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }

        .mobile-controls {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 2px solid #e5e7eb;
            padding: 16px;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
            z-index: 100;
        }

        .display-panel {
            padding-bottom: 120px;
        }

        .admin-locked {
            pointer-events: none;
            opacity: 0.6;
            filter: grayscale(0.3);
        }

        .pulse-animation {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .led-active-label {
            background: linear-gradient(135deg, #ff6b35, #f7931e, #ffcc02);
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 900;
            letter-spacing: 1px;
            text-transform: uppercase;
            box-shadow: 
                0 0 20px rgba(255, 107, 53, 0.7),
                0 0 40px rgba(247, 147, 30, 0.5),
                0 0 60px rgba(255, 204, 2, 0.3),
                0 4px 15px rgba(0, 0, 0, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.4);
            animation: ledGlow 2.5s ease-in-out infinite alternate;
            text-shadow: 
                0 0 10px rgba(255, 255, 255, 0.8),
                0 0 20px rgba(255, 204, 2, 0.7);
            position: relative;
            overflow: hidden;
            transform: scale(1);
            transition: transform 0.3s ease;
        }

        .led-active-label:hover {
            transform: scale(1.05);
        }

        .led-active-label::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.6), transparent);
            animation: ledShine 3.5s infinite;
        }

        .led-active-label::after {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #ff6b35, #f7931e, #ffcc02, #ff6b35);
            border-radius: 32px;
            z-index: -1;
            animation: borderRotate 4s linear infinite;
        }

        @keyframes ledGlow {
            0% {
                box-shadow: 
                    0 0 25px rgba(255, 107, 53, 0.8),
                    0 0 50px rgba(247, 147, 30, 0.6),
                    0 0 75px rgba(255, 204, 2, 0.4),
                    0 6px 20px rgba(0, 0, 0, 0.3);
            }
            100% {
                box-shadow: 
                    0 0 35px rgba(255, 107, 53, 1),
                    0 0 70px rgba(247, 147, 30, 0.8),
                    0 0 100px rgba(255, 204, 2, 0.6),
                    0 8px 25px rgba(0, 0, 0, 0.4);
            }
        }

        @keyframes borderRotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes ledShine {
            0% { left: -100%; }
            50% { left: 100%; }
            100% { left: 100%; }
        }

        /* Google Maps Style Location Indicators */
        .location-indicator {
            animation: locationAppear 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .location-pin {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .pin-head {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #ea4335, #d33b2c);
            border-radius: 50% 50% 50% 0;
            transform: rotate(-45deg);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 
                0 8px 20px rgba(234, 67, 53, 0.4),
                0 4px 12px rgba(0, 0, 0, 0.2),
                inset 0 2px 4px rgba(255, 255, 255, 0.3);
            border: 3px solid #ffffff;
            animation: pinBounce 2s ease-in-out infinite;
        }

        .pin-icon {
            transform: rotate(45deg);
            font-size: 18px;
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .pin-point {
            width: 6px;
            height: 6px;
            background: #ea4335;
            border-radius: 50%;
            margin-top: -3px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .location-pulse {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 60px;
            border: 3px solid #ea4335;
            border-radius: 50%;
            opacity: 0.6;
            animation: locationPulse 2s ease-out infinite;
        }

        .path-indicator {
            animation: pathAppear 0.4s ease-out;
        }

        .path-marker {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #4285f4, #1a73e8);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 
                0 6px 16px rgba(66, 133, 244, 0.4),
                0 2px 8px rgba(0, 0, 0, 0.2);
            border: 2px solid #ffffff;
            animation: pathBounce 1.5s ease-in-out infinite;
        }

        .path-number {
            color: white;
            font-weight: bold;
            font-size: 14px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .path-pulse {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 48px;
            height: 48px;
            border: 2px solid #4285f4;
            border-radius: 50%;
            opacity: 0.5;
            animation: pathPulse 1.8s ease-out infinite;
        }

        @keyframes locationAppear {
            0% {
                transform: translateY(-100px) scale(0.3);
                opacity: 0;
            }
            50% {
                transform: translateY(10px) scale(1.1);
                opacity: 0.8;
            }
            100% {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }

        @keyframes pinBounce {
            0%, 100% {
                transform: rotate(-45deg) translateY(0);
            }
            50% {
                transform: rotate(-45deg) translateY(-8px);
            }
        }

        @keyframes locationPulse {
            0% {
                transform: translate(-50%, -50%) scale(0.8);
                opacity: 0.8;
            }
            100% {
                transform: translate(-50%, -50%) scale(2);
                opacity: 0;
            }
        }

        @keyframes pathAppear {
            0% {
                transform: scale(0) rotate(180deg);
                opacity: 0;
            }
            100% {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
        }

        @keyframes pathBounce {
            0%, 100% {
                transform: translateY(0) scale(1);
            }
            50% {
                transform: translateY(-4px) scale(1.05);
            }
        }

        @keyframes pathPulse {
            0% {
                transform: translate(-50%, -50%) scale(0.9);
                opacity: 0.6;
            }
            100% {
                transform: translate(-50%, -50%) scale(1.8);
                opacity: 0;
            }
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="min-h-full bg-gradient-to-br from-blue-50 to-indigo-100"><!-- Mode Indicator -->
  <div id="mode-indicator" class="mode-indicator user-mode">
   üì± USER MODE
  </div><!-- Main Container -->
  <div class="w-full max-w-none px-2 sm:px-4 lg:px-6 xl:px-8 2xl:px-12 py-6 display-panel" id="main-container"><!-- Header -->
   <header id="main-header" class="text-center mb-8">
    <div class="bg-white rounded-xl shadow-lg p-6 mb-4 relative">
     <div class="absolute top-4 right-4"><button id="nav-toggle-btn" class="bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-lg font-semibold transition-all flex items-center gap-2"> <span>üè†</span> <span class="text-sm">Menu</span> </button>
     </div><!-- Navigation Menu -->
     <nav id="navigation-bar" class="absolute top-16 right-4 bg-white rounded-xl shadow-lg p-3 z-50 hidden fade-in">
      <div class="flex flex-col gap-2 min-w-[150px]"><button id="user-mode-btn" class="nav-btn px-4 py-2 rounded-md font-semibold transition-all flex items-center gap-2 bg-green-500 text-white text-sm"> <span>üë§</span> <span>User</span> </button> <button id="controller-mode-btn" class="nav-btn px-4 py-2 rounded-md font-semibold transition-all flex items-center gap-2 text-gray-600 hover:text-gray-800 text-sm"> <span>üéÆ</span> <span>Controller</span> </button> <button id="display-mode-btn" class="nav-btn px-4 py-2 rounded-md font-semibold transition-all flex items-center gap-2 text-gray-600 hover:text-gray-800 text-sm"> <span>üì∫</span> <span>Display</span> </button>
      </div>
     </nav>
     <div class="flex items-center gap-6"><img src="https://logic.gmsbd.com/platform/file_upload/company_details_1_5639_0.jpg" alt="Company Logo" class="h-16 w-auto object-contain rounded-lg shadow-md" onerror="this.style.display='none'; this.alt='Logo failed to load';">
      <div class="text-left">
       <h1 id="system-title" class="text-3xl font-bold text-blue-800 mb-1" data-system-title>GMS COMPOSITE KNITTING IND LTD</h1>
       <p class="text-lg font-semibold text-gray-700" data-display-title>FINISH FABRICS MCD</p>
      </div>
     </div><!-- Status Indicators -->
     <div class="flex justify-center gap-4 mt-4">
      <div id="connection-status" class="flex items-center gap-2 px-3 py-1 rounded-full bg-green-100 text-green-800 text-sm">
       <div class="w-2 h-2 bg-green-500 rounded-full pulse-animation"></div><span>Connected</span>
      </div>
      <div id="admin-status" class="flex items-center gap-2 px-3 py-1 rounded-full bg-gray-100 text-gray-600 text-sm">
       <div class="w-2 h-2 bg-gray-400 rounded-full"></div><span>Admin Offline</span>
      </div>
     </div>
    </div>
   </header><!-- Controller Access Panel -->
   <div id="controller-access" class="bg-white rounded-xl shadow-lg p-6 mb-8 hidden">
    <h3 class="text-xl font-semibold text-gray-800 mb-4">Controller Access</h3>
    <div class="space-y-4">
     <div><label for="access-code" class="block text-sm font-medium text-gray-700 mb-2">Enter Controller Code</label> <input type="password" id="access-code" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:outline-none transition-colors" placeholder="Enter access code">
     </div>
     <div class="flex gap-3"><button id="verify-code-btn" class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors"> Verify &amp; Enter Controller Mode </button> <button id="cancel-controller-btn" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-semibold transition-colors"> Cancel </button>
     </div>
    </div>
   </div><!-- User Controls -->
   <div id="user-controls" class="bg-white rounded-xl shadow-lg p-6 mb-8">
    <div class="flex flex-col md:flex-row gap-4 items-center justify-between">
     <div class="flex-1 max-w-md">
      <div class="relative"><input type="text" id="search-input" placeholder="Search by buyer or rack location..." class="w-full px-4 py-3 pl-10 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none transition-colors">
       <svg class="absolute left-3 top-3.5 h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
       </svg>
      </div>
     </div>
     <div class="flex items-center gap-3"><label for="items-per-row" class="text-sm font-medium text-gray-700">Items per row:</label> <select id="items-per-row" class="px-3 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none transition-colors"> <option value="auto">Auto</option> <option value="2">2</option> <option value="4">4</option> <option value="6">6</option> <option value="8">8</option> <option value="10">10</option> <option value="12">12</option> <option value="16">16</option> <option value="20">20</option> </select>
     </div><button id="user-add-item-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors flex items-center gap-2">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
      </svg><span>Add New Item</span> </button>
    </div>
    <div class="mt-4 flex justify-center">
     <div class="bg-gray-50 rounded-lg px-4 py-2"><span class="text-gray-600">Total Items: </span> <span id="total-count" class="font-bold text-blue-600">0</span>
     </div>
    </div>
   </div><!-- Add Item Form (For All Users) -->
   <div id="user-add-item-form" class="bg-white rounded-xl shadow-lg p-6 mb-8 hidden">
    <h3 class="text-xl font-semibold mb-4 text-gray-800 flex items-center gap-2"><span class="text-2xl">‚ûï</span> Add New Item</h3>
    <form id="user-item-form" class="space-y-4">
     <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div><label for="user-buyer-name" class="block text-sm font-medium text-gray-700 mb-2">BUYER NAME *</label> <input type="text" id="user-buyer-name" placeholder="Enter buyer name" required class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none transition-colors text-lg font-medium">
      </div>
      <div><label for="user-rack-location" class="block text-sm font-medium text-gray-700 mb-2">RACK LOCATION *</label> <input type="text" id="user-rack-location" placeholder="Enter rack location" required class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none transition-colors text-lg font-medium">
      </div>
     </div>
     <div><label for="user-sr-id-no" class="block text-sm font-medium text-gray-700 mb-2">SR/ID NO (Optional)</label> <input type="text" id="user-sr-id-no" placeholder="Enter SR/ID number (optional)" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none transition-colors text-lg font-medium">
     </div>
     <div class="flex gap-3"><button type="submit" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-3 px-6 rounded-lg font-semibold flex items-center justify-center gap-2 transition-colors"> <span id="user-add-btn-text">Add Item</span>
       <div id="user-add-btn-spinner" class="loading-spinner hidden"></div></button> <button type="button" id="user-cancel-add-btn" class="px-6 py-3 bg-gray-500 hover:bg-gray-600 text-white rounded-lg font-semibold transition-colors"> Cancel </button>
     </div>
    </form>
   </div><!-- Search and Filter Bar -->
   <div id="search-filter-bar" class="bg-white rounded-xl shadow-lg p-4 mb-6 hidden">
    <div class="flex flex-col sm:flex-row gap-4">
     <div class="flex-1"><input type="text" id="search-input" placeholder="Search by buyer name or rack location..." class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-lg">
     </div>
     <div class="flex gap-2"><select id="item-type-filter" class="px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-lg"> <option value="">All Types</option> <option value="Finish Fabric">Finish Fabric</option> <option value="Yarn">Yarn</option> <option value="Grey Fabric">Grey Fabric</option> <option value="Accessories">Accessories</option> </select> <button id="clear-search-btn" class="px-6 py-3 bg-gray-500 hover:bg-gray-600 text-white rounded-lg font-semibold transition-all"> Clear </button>
     </div>
    </div>
   </div><!-- Inventory Grid -->
   <div id="inventory-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-6"><!-- Items will be rendered here -->
   </div><!-- Empty State -->
   <div id="empty-state" class="hidden text-center py-12">
    <div class="text-6xl mb-4">
     üì¶
    </div>
    <h3 class="text-xl font-semibold text-gray-600 mb-2">No Items Found</h3>
    <p class="text-gray-500">Add some inventory items to get started</p>
   </div>
  </div><!-- Mobile Controls (Controller Mode Only) -->
  <div id="mobile-controls" class="mobile-controls hidden">
   <div class="flex flex-col gap-4"><!-- Add Item Form -->
    <div id="add-item-form" class="hidden bg-gray-50 p-4 rounded-lg">
     <h3 class="text-lg font-semibold mb-3">Add New Item</h3>
     <form id="item-form" class="space-y-3">
      <div class="space-y-3"><input type="text" id="buyer-name" placeholder="BUYER NAME" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-lg font-medium"> <input type="text" id="rack-location" placeholder="RACK LOCATION" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-lg font-medium"> <input type="text" id="sr-id-no" placeholder="SR/ID NO (Optional)" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-lg font-medium">
      </div>
      <div class="flex gap-2"><button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-lg font-semibold flex items-center justify-center gap-2"> <span id="add-btn-text">Add Item</span>
        <div id="add-btn-spinner" class="loading-spinner hidden"></div></button> <button type="button" id="cancel-add-btn" class="px-4 py-3 bg-gray-500 hover:bg-gray-600 text-white rounded-lg font-semibold"> Cancel </button>
      </div>
     </form>
    </div><!-- Control Buttons -->
    <div class="flex gap-2"><button id="add-item-btn" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-3 px-4 rounded-lg font-semibold flex items-center justify-center gap-2"> <span>‚ûï</span> <span>Add Item</span> </button> <button id="clear-highlights-btn" class="px-4 py-3 bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg font-semibold"> üîç </button> <button id="scroll-top-btn" class="px-4 py-3 bg-purple-500 hover:bg-purple-600 text-white rounded-lg font-semibold"> ‚¨ÜÔ∏è </button> <button id="controller-logout-btn" class="px-4 py-3 bg-red-500 hover:bg-red-600 text-white rounded-lg font-semibold flex items-center gap-1"> <span>üö™</span> <span class="text-sm">Logout</span> </button>
    </div>
   </div>
  </div><!-- Admin Lock Overlay -->
  <div id="admin-lock-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
   <div class="bg-white p-8 rounded-xl text-center max-w-sm mx-4">
    <div class="text-6xl mb-4">
     üîí
    </div>
    <h3 class="text-xl font-semibold mb-2">Controller Active</h3>
    <p class="text-gray-600 mb-4">A controller is currently managing this display</p>
    <div class="flex items-center justify-center gap-2 text-blue-600">
     <div class="w-2 h-2 bg-blue-500 rounded-full pulse-animation"></div><span class="text-sm">Syncing...</span>
    </div>
   </div>
  </div>
  <script>
        // Global variables
        let currentMode = 'user';
        let inventoryData = [];
        let filteredData = [];
        let currentRecordCount = 0;
        let isAdminActive = false;
        let highlightedItems = new Set();
        let adminSessionId = null;
        let lastCommandId = 0;
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCTQZ0B_tZ8fY8Jh5pLxXl8fXKcTjYdU4",
            authDomain: "finish-fab-display-default-rtdb.firebaseapp.com",
            databaseURL: "https://finish-fab-display-default-rtdb.firebaseio.com",
            projectId: "finish-fab-display-default-rtdb",
            storageBucket: "finish-fab-display-default-rtdb.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef123456"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Configuration
        const defaultConfig = {
            company_name: "GMS Textiles",
            system_title: "GMS COMPOSITE KNITTING IND LTD",
            display_title: "FINISH FABRICS MCD RACK DISPLAY"
        };

        // Initialize SDK
        async function initializeSDK() {
            if (window.elementSdk) {
                window.elementSdk.init({
                    defaultConfig,
                    onConfigChange: async (config) => {
                        // Update company name
                        const companyElements = document.querySelectorAll('[data-company-name]');
                        companyElements.forEach(el => {
                            el.textContent = config.company_name || defaultConfig.company_name;
                        });

                        // Update system title
                        const systemTitleElements = document.querySelectorAll('[data-system-title]');
                        systemTitleElements.forEach(el => {
                            el.textContent = config.system_title || defaultConfig.system_title;
                        });

                        // Update display title
                        const displayTitleElements = document.querySelectorAll('[data-display-title]');
                        displayTitleElements.forEach(el => {
                            el.textContent = config.display_title || defaultConfig.display_title;
                        });
                    },
                    mapToCapabilities: (config) => ({
                        recolorables: [],
                        borderables: [],
                        fontEditable: undefined,
                        fontSizeable: undefined
                    }),
                    mapToEditPanelValues: (config) => new Map([
                        ["company_name", config.company_name || defaultConfig.company_name],
                        ["system_title", config.system_title || defaultConfig.system_title],
                        ["display_title", config.display_title || defaultConfig.display_title]
                    ])
                });
            }
            
            // Set up Firebase listeners
            setupFirebaseListeners();
        }

        // Firebase listeners
        function setupFirebaseListeners() {
            // Listen for inventory items
            database.ref('inventory').on('value', (snapshot) => {
                const data = snapshot.val() || {};
                inventoryData = Object.keys(data).map(key => ({
                    id: key,
                    ...data[key]
                }));
                
                currentRecordCount = inventoryData.length;
                
                // Apply current filters and render
                applyFilters();
                renderInventory();
                
                // Update total count display
                updateTotalCount();
            });
            
            // Listen for admin session
            database.ref('session_admin').on('value', (snapshot) => {
                const adminSession = snapshot.val();
                updateAdminStatus(adminSession);
            });
            
            // Listen for sync commands
            database.ref('commands').on('value', (snapshot) => {
                const commands = snapshot.val() || {};
                const commandList = Object.keys(commands).map(key => ({
                    id: key,
                    ...commands[key]
                }));
                
                if (commandList.length > 0 && currentMode !== 'controller') {
                    processSyncCommands(commandList);
                }
            });
        }

        // Controller access functions
        function showControllerAccess() {
            document.getElementById('controller-access').classList.remove('hidden');
            document.getElementById('navigation-bar').classList.add('hidden');
            document.getElementById('access-code').focus();
        }

        function hideControllerAccess() {
            document.getElementById('controller-access').classList.add('hidden');
            document.getElementById('access-code').value = '';
        }

        function verifyControllerCode() {
            const code = document.getElementById('access-code').value;
            const correctCode = '1234'; // You can change this to any code you want
            
            if (code === correctCode) {
                hideControllerAccess();
                switchMode('controller');
                showToast('Controller access granted', 'success');
            } else {
                showToast('Invalid access code', 'error');
                document.getElementById('access-code').value = '';
                document.getElementById('access-code').focus();
            }
        }

        // Mode switching
        function switchMode(mode) {
            currentMode = mode;
            
            // Update mode indicator
            const modeIndicator = document.getElementById('mode-indicator');
            const modeText = {
                'user': 'üë§ USER MODE',
                'controller': 'üéÆ CONTROLLER MODE',
                'display': 'üì∫ DISPLAY MODE'
            };
            
            modeIndicator.textContent = modeText[mode];
            modeIndicator.className = `mode-indicator ${mode}-mode`;
            
            // Update navigation buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('bg-green-500', 'bg-blue-500', 'bg-purple-500', 'text-white');
                btn.classList.add('text-gray-600', 'hover:text-gray-800');
            });
            
            const activeBtn = document.getElementById(`${mode}-mode-btn`);
            if (activeBtn) {
                activeBtn.classList.remove('text-gray-600', 'hover:text-gray-800');
                const colors = {
                    'user': 'bg-green-500',
                    'controller': 'bg-blue-500',
                    'display': 'bg-purple-500'
                };
                activeBtn.classList.add(colors[mode], 'text-white');
            }
            
            // Show/hide mobile controls
            const mobileControls = document.getElementById('mobile-controls');
            if (mode === 'controller') {
                mobileControls.classList.remove('hidden');
                startControllerSession();
            } else {
                mobileControls.classList.add('hidden');
                if (adminSessionId) {
                    clearControllerSession();
                }
            }
            
            // Hide navigation
            document.getElementById('navigation-bar').classList.add('hidden');
            
            // Clear search and highlights when switching modes
            if (mode !== 'controller') {
                document.getElementById('search-input').value = '';
                highlightedItems.clear();
                applyFilters();
                renderInventory();
            }
            
            // Update UI based on admin status
            updateUIForAdminStatus();
            
            // Show mode-specific notifications
            if (mode === 'controller') {
                showLiveSyncNotification();
            } else if (mode === 'display') {
                showDisplayModeNotification();
            }
        }

        function showLiveSyncNotification() {
            const notification = document.createElement('div');
            notification.className = 'fixed top-20 left-1/2 transform -translate-x-1/2 z-50 bg-blue-600 text-white px-6 py-4 rounded-lg shadow-lg max-w-md text-center';
            notification.innerHTML = `
                <div class="flex items-center gap-3">
                    <div class="text-2xl">üéÆ</div>
                    <div>
                        <div class="font-semibold">Live Screen Control Active</div>
                        <div class="text-sm opacity-90">All users will see your actions in real-time</div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 4000);
        }

        function showDisplayModeNotification() {
            const notification = document.createElement('div');
            notification.className = 'fixed top-20 left-1/2 transform -translate-x-1/2 z-50 bg-purple-600 text-white px-6 py-4 rounded-lg shadow-lg max-w-md text-center';
            notification.innerHTML = `
                <div class="flex items-center gap-3">
                    <div class="text-2xl">üì∫</div>
                    <div>
                        <div class="font-semibold">Display Mode Active</div>
                        <div class="text-sm opacity-90">Perfect for TV screens and monitoring</div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Controller session management
        async function startControllerSession() {
            if (currentMode === 'controller') {
                adminSessionId = 'admin_' + Date.now();
                const sessionData = {
                    session_type: 'admin_active',
                    admin_id: adminSessionId,
                    screen_control_active: true,
                    current_view: 'inventory',
                    scroll_position: 0,
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };
                
                await database.ref('session_admin').set(sessionData);
                
                // Start heartbeat and screen sync
                startControllerHeartbeat();
                startScreenSync();
                
                showToast('üéÆ Live Screen Control Active - All users will see your actions', 'success');
            }
        }

        // Controller logout function
        async function logoutController() {
            if (currentMode === 'controller') {
                // Clear controller session
                await clearControllerSession();
                
                // Switch back to user mode instead of refreshing
                switchMode('user');
                
                // Show logout message
                showToast('üö™ Controller logged out successfully', 'success');
            }
        }

        async function clearControllerSession() {
            if (adminSessionId) {
                // Remove admin session
                await database.ref('session_admin').remove();
                
                // Clear all sync commands
                await database.ref('commands').remove();
                
                adminSessionId = null;
            }
        }

        function startControllerHeartbeat() {
            setInterval(async () => {
                if (currentMode === 'controller' && adminSessionId) {
                    const sessionRef = database.ref('session_admin');
                    sessionRef.once('value').then((snapshot) => {
                        const sessionData = snapshot.val();
                        if (sessionData) {
                            sessionRef.update({
                                updated_at: new Date().toISOString(),
                                scroll_position: window.pageYOffset
                            });
                        }
                    });
                }
            }, 1000); // More frequent updates for better sync
        }

        // Screen synchronization system
        function startScreenSync() {
            if (currentMode !== 'controller') return;
            
            // Track scroll position
            let scrollTimeout;
            window.addEventListener('scroll', () => {
                clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(async () => {
                    await syncScrollPosition();
                }, 100);
            });
            
            // Track search input changes
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                searchInput.addEventListener('input', debounce(syncSearchQuery, 300));
            }
            
            // Track grid layout changes
            const itemsPerRow = document.getElementById('items-per-row');
            if (itemsPerRow) {
                itemsPerRow.addEventListener('change', syncGridLayout);
            }
        }

        async function syncScrollPosition() {
            if (currentMode === 'controller') {
                await sendSyncCommand('sync_scroll', {
                    scrollY: window.pageYOffset,
                    timestamp: Date.now()
                });
            }
        }

        async function syncSearchQuery() {
            if (currentMode === 'controller') {
                const query = document.getElementById('search-input').value;
                await sendSyncCommand('sync_search', {
                    query: query,
                    timestamp: Date.now()
                });
            }
        }

        async function syncGridLayout() {
            if (currentMode === 'controller') {
                const layout = document.getElementById('items-per-row').value;
                await sendSyncCommand('sync_grid', {
                    layout: layout,
                    timestamp: Date.now()
                });
            }
        }

        // Debounce utility function
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Admin status management
        function updateAdminStatus(adminSession) {
            const wasAdminActive = isAdminActive;
            
            if (adminSession) {
                const lastUpdate = new Date(adminSession.updated_at);
                const now = new Date();
                const timeDiff = now - lastUpdate;
                
                // Admin is active if last update was within 10 seconds
                isAdminActive = timeDiff < 10000;
            } else {
                isAdminActive = false;
            }
            
            // Update UI if status changed
            if (wasAdminActive !== isAdminActive) {
                updateUIForAdminStatus();
            }
        }

        function updateUIForAdminStatus() {
            const adminStatusEl = document.getElementById('admin-status');
            const lockOverlay = document.getElementById('admin-lock-overlay');
            const mainContainer = document.getElementById('main-container');
            
            if (isAdminActive && currentMode !== 'controller') {
                // Show live screen control status
                adminStatusEl.innerHTML = `
                    <div class="w-2 h-2 bg-red-500 rounded-full pulse-animation"></div>
                    <span>üéÆ Live Screen Control</span>
                `;
                adminStatusEl.className = 'flex items-center gap-2 px-3 py-1 rounded-full bg-red-100 text-red-800 text-sm font-semibold';
                
                // Update lock overlay message
                const lockOverlayContent = lockOverlay.querySelector('.bg-white');
                if (lockOverlayContent) {
                    lockOverlayContent.innerHTML = `
                        <div class="text-6xl mb-4">üéÆ</div>
                        <h3 class="text-xl font-semibold mb-2 text-red-600">Live Screen Control Active</h3>
                        <p class="text-gray-600 mb-4">A controller is managing this display in real-time</p>
                        <div class="bg-red-50 border border-red-200 rounded-lg p-3 mb-4">
                            <p class="text-sm text-red-700">
                                <strong>View-Only Mode:</strong><br>
                                You can see all changes but cannot interact with the system
                            </p>
                        </div>
                        <div class="flex items-center justify-center gap-2 text-red-600">
                            <div class="w-2 h-2 bg-red-500 rounded-full pulse-animation"></div>
                            <span class="text-sm font-semibold">Live Syncing...</span>
                        </div>
                    `;
                }
                
                // Show lock overlay for user and display modes
                if (currentMode === 'user' || currentMode === 'display') {
                    lockOverlay.classList.remove('hidden');
                    mainContainer.classList.add('admin-locked');
                }
            } else {
                // Show controller offline status
                adminStatusEl.innerHTML = `
                    <div class="w-2 h-2 bg-gray-400 rounded-full"></div>
                    <span>Controller Offline</span>
                `;
                adminStatusEl.className = 'flex items-center gap-2 px-3 py-1 rounded-full bg-gray-100 text-gray-600 text-sm';
                
                // Hide lock overlay
                lockOverlay.classList.add('hidden');
                mainContainer.classList.remove('admin-locked');
            }
        }

        // Sync command system
        async function sendSyncCommand(action, data) {
            if (currentMode === 'controller') {
                const commandId = ++lastCommandId;
                const commandKey = `cmd_${commandId}_${Date.now()}`;
                const commandData = {
                    command_type: action,
                    command_data: JSON.stringify(data),
                    admin_id: adminSessionId,
                    timestamp: new Date().toISOString(),
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };
                
                await database.ref(`commands/${commandKey}`).set(commandData);
                
                // Auto-delete command after 5 seconds
                setTimeout(async () => {
                    await database.ref(`commands/${commandKey}`).remove();
                }, 5000);
            }
        }

        function processSyncCommands(commands) {
            if (currentMode === 'controller') return; // Controller doesn't process its own commands
            
            commands.forEach(cmd => {
                if (cmd.command_type && cmd.command_data) {
                    const data = JSON.parse(cmd.command_data);
                    
                    switch (cmd.command_type) {
                        case 'search':
                            document.getElementById('search-input').value = data.query || '';
                            highlightedItems.clear();
                            if (data.highlightedItems) {
                                data.highlightedItems.forEach(id => highlightedItems.add(id));
                            }
                            applyFilters();
                            renderInventory();
                            scrollToFirstHighlighted();
                            break;
                            
                        case 'filter':
                            document.getElementById('item-type-filter').value = data.itemType || '';
                            applyFilters();
                            renderInventory();
                            break;
                            
                        case 'clear_highlights':
                            highlightedItems.clear();
                            document.getElementById('search-input').value = '';
                            document.getElementById('item-type-filter').value = '';
                            applyFilters();
                            renderInventory();
                            break;
                            
                        case 'scroll_to_top':
                            window.scrollTo({ top: 0, behavior: 'smooth' });
                            break;
                            
                        // New live sync commands
                        case 'sync_scroll':
                            if (data.scrollY !== undefined) {
                                window.scrollTo({ top: data.scrollY, behavior: 'smooth' });
                            }
                            break;
                            
                        case 'sync_search':
                            const searchInput = document.getElementById('search-input');
                            if (searchInput && searchInput.value !== data.query) {
                                searchInput.value = data.query || '';
                                applyFilters();
                                renderInventory();
                            }
                            break;
                            
                        case 'sync_grid':
                            const gridSelect = document.getElementById('items-per-row');
                            if (gridSelect && gridSelect.value !== data.layout) {
                                gridSelect.value = data.layout;
                                updateGridLayout(data.layout);
                            }
                            break;
                    }
                }
            });
        }

        // Grid layout management
        function updateGridLayout(itemsPerRow) {
            const grid = document.getElementById('inventory-grid');
            
            // Remove existing grid classes
            grid.className = grid.className.replace(/grid-cols-\d+/g, '');
            
            // Apply new grid layout
            let gridClasses = 'grid gap-6 ';
            switch(itemsPerRow) {
                case '2':
                    gridClasses += 'grid-cols-1 sm:grid-cols-2';
                    break;
                case '4':
                    gridClasses += 'grid-cols-1 sm:grid-cols-2 lg:grid-cols-4';
                    break;
                case '6':
                    gridClasses += 'grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-6';
                    break;
                case '8':
                    gridClasses += 'grid-cols-1 sm:grid-cols-2 md:grid-cols-4 lg:grid-cols-8';
                    break;
                case '10':
                    gridClasses += 'grid-cols-1 sm:grid-cols-2 md:grid-cols-5 lg:grid-cols-10';
                    break;
                case '12':
                    gridClasses += 'grid-cols-1 sm:grid-cols-3 md:grid-cols-6 lg:grid-cols-12';
                    break;
                case '16':
                    gridClasses += 'grid-cols-1 sm:grid-cols-4 md:grid-cols-8 lg:grid-cols-16';
                    break;
                case '20':
                    gridClasses += 'grid-cols-1 sm:grid-cols-4 md:grid-cols-10 lg:grid-cols-20';
                    break;
                default: // auto
                    gridClasses += 'grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5';
            }
            
            grid.className = gridClasses;
        }

        // Search and filter functionality
        function applyFilters() {
            const searchInput = document.getElementById('search-input');
            const itemTypeFilter = document.getElementById('item-type-filter');
            
            const searchQuery = searchInput ? searchInput.value.toLowerCase() : '';
            const itemTypeValue = itemTypeFilter ? itemTypeFilter.value : '';
            
            console.log('Applying filters - Search:', searchQuery, 'Type:', itemTypeValue, 'Total items:', inventoryData.length);
            
            filteredData = inventoryData.filter(item => {
                // Ensure item has required properties
                if (!item.buyer_name || !item.rack_location) {
                    console.warn('Item missing required properties:', item);
                    return false;
                }
                
                const matchesSearch = !searchQuery || 
                    item.buyer_name.toLowerCase().includes(searchQuery) ||
                    item.rack_location.toLowerCase().includes(searchQuery) ||
                    (item.sr_id_no && item.sr_id_no.toLowerCase().includes(searchQuery));
                
                const matchesType = !itemTypeValue || item.item_type === itemTypeValue;
                
                return matchesSearch && matchesType;
            });
            
            console.log('Filtered to', filteredData.length, 'items');
            
            // Update highlights and navigation based on search
            if (searchQuery) {
                highlightedItems.clear();
                filteredData.forEach(item => {
                    if (item.buyer_name.toLowerCase().includes(searchQuery) ||
                        item.rack_location.toLowerCase().includes(searchQuery) ||
                        (item.sr_id_no && item.sr_id_no.toLowerCase().includes(searchQuery))) {
                        highlightedItems.add(item.id);
                    }
                });
                
                // Show navigation panel if there are search results
                if (highlightedItems.size > 0) {
                    showNavigationPanel();
                }
                
                // Send sync command for controller mode
                if (currentMode === 'controller') {
                    sendSyncCommand('search', {
                        query: searchQuery,
                        highlightedItems: Array.from(highlightedItems)
                    });
                }
            } else {
                // Hide navigation panel when no search
                hideNavigationPanel();
            }
        }

        // Navigation panel functions
        function showNavigationPanel() {
            let navPanel = document.getElementById('navigation-panel');
            if (!navPanel) {
                createNavigationPanel();
                navPanel = document.getElementById('navigation-panel');
            }
            
            navPanel.classList.remove('hidden');
            updateNavigationPanel();
        }

        function hideNavigationPanel() {
            const navPanel = document.getElementById('navigation-panel');
            if (navPanel) {
                navPanel.classList.add('hidden');
            }
        }

        function createNavigationPanel() {
            const panel = document.createElement('div');
            panel.id = 'navigation-panel';
            panel.className = 'fixed bottom-20 right-4 bg-white rounded-2xl shadow-2xl p-6 z-40 border-2 border-blue-200 hidden';
            panel.style.cssText = `
                background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
                box-shadow: 
                    0 20px 40px rgba(59, 130, 246, 0.15),
                    0 10px 25px rgba(0, 0, 0, 0.1),
                    0 0 0 1px rgba(59, 130, 246, 0.1);
                backdrop-filter: blur(10px);
                min-width: 280px;
                max-width: 320px;
            `;
            
            panel.innerHTML = `
                <div class="flex items-center gap-3 mb-4 pb-3 border-b border-blue-100">
                    <div class="bg-gradient-to-r from-blue-500 to-indigo-600 p-2 rounded-lg">
                        <span class="text-white text-lg">üó∫Ô∏è</span>
                    </div>
                    <div>
                        <h3 class="font-bold text-gray-800 text-lg">Search Navigation</h3>
                        <p class="text-sm text-gray-600">Found locations</p>
                    </div>
                </div>
                
                <div id="nav-results-info" class="mb-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                    <div class="flex items-center gap-2 text-blue-700">
                        <span class="text-lg">üìç</span>
                        <span class="font-semibold">0 locations found</span>
                    </div>
                </div>
                
                <div class="space-y-3">
                    <button id="nav-first-btn" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white py-3 px-4 rounded-lg font-semibold transition-all flex items-center justify-center gap-2 shadow-lg">
                        <span>üéØ</span>
                        <span>Go to First Result</span>
                    </button>
                    
                    <div class="grid grid-cols-2 gap-2">
                        <button id="nav-prev-btn" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-3 rounded-lg font-semibold transition-all flex items-center justify-center gap-1 text-sm">
                            <span>‚¨ÜÔ∏è</span>
                            <span>Previous</span>
                        </button>
                        <button id="nav-next-btn" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-3 rounded-lg font-semibold transition-all flex items-center justify-center gap-1 text-sm">
                            <span>‚¨áÔ∏è</span>
                            <span>Next</span>
                        </button>
                    </div>
                    
                    <button id="nav-show-all-btn" class="w-full bg-gradient-to-r from-purple-500 to-violet-600 hover:from-purple-600 hover:to-violet-700 text-white py-3 px-4 rounded-lg font-semibold transition-all flex items-center justify-center gap-2 shadow-lg">
                        <span>üëÅÔ∏è</span>
                        <span>Show All Results</span>
                    </button>
                    
                    <button id="nav-close-btn" class="w-full bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded-lg font-semibold transition-all flex items-center justify-center gap-2 text-sm">
                        <span>‚ùå</span>
                        <span>Close Navigation</span>
                    </button>
                </div>
            `;
            
            document.body.appendChild(panel);
            
            // Add event listeners
            document.getElementById('nav-first-btn').addEventListener('click', navigateToFirst);
            document.getElementById('nav-prev-btn').addEventListener('click', navigateToPrevious);
            document.getElementById('nav-next-btn').addEventListener('click', navigateToNext);
            document.getElementById('nav-show-all-btn').addEventListener('click', showAllResults);
            document.getElementById('nav-close-btn').addEventListener('click', closeNavigation);
        }

        let currentNavigationIndex = 0;

        function updateNavigationPanel() {
            const resultsInfo = document.getElementById('nav-results-info');
            const highlightedArray = Array.from(highlightedItems);
            
            if (resultsInfo) {
                resultsInfo.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2 text-blue-700">
                            <span class="text-lg">üìç</span>
                            <span class="font-semibold">${highlightedArray.length} locations found</span>
                        </div>
                        ${highlightedArray.length > 0 ? `
                            <div class="text-sm text-blue-600 font-medium">
                                ${currentNavigationIndex + 1} of ${highlightedArray.length}
                            </div>
                        ` : ''}
                    </div>
                `;
            }
            
            // Update button states
            const prevBtn = document.getElementById('nav-prev-btn');
            const nextBtn = document.getElementById('nav-next-btn');
            
            if (prevBtn && nextBtn) {
                prevBtn.disabled = currentNavigationIndex === 0;
                nextBtn.disabled = currentNavigationIndex >= highlightedArray.length - 1;
                
                prevBtn.className = currentNavigationIndex === 0 ? 
                    'bg-gray-300 text-gray-500 py-2 px-3 rounded-lg font-semibold flex items-center justify-center gap-1 text-sm cursor-not-allowed' :
                    'bg-gray-500 hover:bg-gray-600 text-white py-2 px-3 rounded-lg font-semibold transition-all flex items-center justify-center gap-1 text-sm';
                    
                nextBtn.className = currentNavigationIndex >= highlightedArray.length - 1 ? 
                    'bg-gray-300 text-gray-500 py-2 px-3 rounded-lg font-semibold flex items-center justify-center gap-1 text-sm cursor-not-allowed' :
                    'bg-gray-500 hover:bg-gray-600 text-white py-2 px-3 rounded-lg font-semibold transition-all flex items-center justify-center gap-1 text-sm';
            }
        }

        function navigateToFirst() {
            const highlightedArray = Array.from(highlightedItems);
            if (highlightedArray.length > 0) {
                currentNavigationIndex = 0;
                scrollToItem(highlightedArray[0]);
                updateNavigationPanel();
                showLocationIndicator(highlightedArray[0]);
            }
        }

        function navigateToPrevious() {
            const highlightedArray = Array.from(highlightedItems);
            if (currentNavigationIndex > 0) {
                currentNavigationIndex--;
                scrollToItem(highlightedArray[currentNavigationIndex]);
                updateNavigationPanel();
                showLocationIndicator(highlightedArray[currentNavigationIndex]);
            }
        }

        function navigateToNext() {
            const highlightedArray = Array.from(highlightedItems);
            if (currentNavigationIndex < highlightedArray.length - 1) {
                currentNavigationIndex++;
                scrollToItem(highlightedArray[currentNavigationIndex]);
                updateNavigationPanel();
                showLocationIndicator(highlightedArray[currentNavigationIndex]);
            }
        }

        function showAllResults() {
            // Scroll to show all highlighted items in view
            const highlightedElements = document.querySelectorAll('.highlighted');
            if (highlightedElements.length > 0) {
                const firstElement = highlightedElements[0];
                const lastElement = highlightedElements[highlightedElements.length - 1];
                
                // Calculate the center point between first and last elements
                const firstRect = firstElement.getBoundingClientRect();
                const lastRect = lastElement.getBoundingClientRect();
                const centerY = (firstRect.top + lastRect.bottom) / 2;
                const scrollY = window.pageYOffset + centerY - window.innerHeight / 2;
                
                window.scrollTo({ top: scrollY, behavior: 'smooth' });
                
                // Show path indicators for all results
                showPathIndicators();
            }
        }

        function closeNavigation() {
            hideNavigationPanel();
            // Clear search
            document.getElementById('search-input').value = '';
            highlightedItems.clear();
            applyFilters();
            renderInventory();
            removeAllIndicators();
        }

        function scrollToItem(itemId) {
            const element = document.querySelector(`[data-item-id="${itemId}"]`);
            if (element) {
                element.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center',
                    inline: 'nearest'
                });
                
                // Add extra highlight animation
                element.style.animation = 'none';
                setTimeout(() => {
                    element.style.animation = 'pulse 1s ease-in-out 3';
                }, 100);
            }
        }

        function showLocationIndicator(itemId) {
            // Remove existing indicators
            removeAllIndicators();
            
            const element = document.querySelector(`[data-item-id="${itemId}"]`);
            if (element) {
                // Create location indicator (like Google Maps pin)
                const indicator = document.createElement('div');
                indicator.className = 'location-indicator';
                indicator.innerHTML = `
                    <div class="location-pin">
                        <div class="pin-head">
                            <span class="pin-icon">üë§</span>
                        </div>
                        <div class="pin-point"></div>
                    </div>
                    <div class="location-pulse"></div>
                `;
                
                // Position indicator
                const rect = element.getBoundingClientRect();
                indicator.style.cssText = `
                    position: fixed;
                    top: ${rect.top - 60}px;
                    left: ${rect.left + rect.width / 2 - 20}px;
                    z-index: 1000;
                    pointer-events: none;
                `;
                
                document.body.appendChild(indicator);
                
                // Auto remove after 5 seconds
                setTimeout(() => {
                    if (indicator.parentNode) {
                        indicator.remove();
                    }
                }, 5000);
            }
        }

        function showPathIndicators() {
            removeAllIndicators();
            
            const highlightedElements = document.querySelectorAll('.highlighted');
            highlightedElements.forEach((element, index) => {
                setTimeout(() => {
                    const indicator = document.createElement('div');
                    indicator.className = 'path-indicator';
                    indicator.innerHTML = `
                        <div class="path-marker">
                            <span class="path-number">${index + 1}</span>
                        </div>
                        <div class="path-pulse"></div>
                    `;
                    
                    const rect = element.getBoundingClientRect();
                    indicator.style.cssText = `
                        position: fixed;
                        top: ${rect.top - 40}px;
                        left: ${rect.left + rect.width - 40}px;
                        z-index: 999;
                        pointer-events: none;
                    `;
                    
                    document.body.appendChild(indicator);
                    
                    // Auto remove after 8 seconds
                    setTimeout(() => {
                        if (indicator.parentNode) {
                            indicator.remove();
                        }
                    }, 8000);
                }, index * 200); // Stagger the appearance
            });
        }

        function removeAllIndicators() {
            document.querySelectorAll('.location-indicator, .path-indicator').forEach(indicator => {
                indicator.remove();
            });
        }

        function scrollToFirstHighlighted() {
            if (highlightedItems.size > 0) {
                setTimeout(() => {
                    const firstHighlighted = document.querySelector('.highlighted');
                    if (firstHighlighted) {
                        firstHighlighted.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 100);
            }
        }

        // Render inventory
        function renderInventory() {
            const grid = document.getElementById('inventory-grid');
            const emptyState = document.getElementById('empty-state');
            
            console.log('Rendering inventory:', filteredData.length, 'filtered items from', inventoryData.length, 'total items');
            
            if (filteredData.length === 0) {
                if (inventoryData.length === 0) {
                    // No items at all
                    grid.classList.add('hidden');
                    emptyState.classList.remove('hidden');
                } else {
                    // Items exist but filtered out
                    grid.innerHTML = '<div class="col-span-full text-center py-8 text-gray-500">No items match your search criteria</div>';
                    grid.classList.remove('hidden');
                    emptyState.classList.add('hidden');
                }
                return;
            }
            
            grid.classList.remove('hidden');
            emptyState.classList.add('hidden');
            
            // Create cards for filtered items
            const cardsHTML = filteredData.map(item => createItemCard(item)).join('');
            grid.innerHTML = cardsHTML;
            
            console.log('Rendered', filteredData.length, 'item cards');
        }

        function createItemCard(item) {
            const isHighlighted = highlightedItems.has(item.id);
            const highlightClass = isHighlighted ? 'highlighted' : '';

            const srIdDisplay = item.sr_id_no ? 
                `<div class="flex items-center gap-3 mb-3 bg-gradient-to-r from-amber-50 to-orange-50 p-3 rounded-xl border-l-4 border-amber-400 shadow-sm relative group">
                    <div class="bg-gradient-to-br from-amber-400 to-orange-500 p-2 rounded-lg shadow-md">
                        <span class="text-white text-lg">üè∑Ô∏è</span>
                    </div>
                    <div class="flex-1">
                        <div class="text-xs text-amber-600 font-bold uppercase tracking-wide">SR/ID NO</div>
                        <div class="font-black text-amber-800 text-xl">${item.sr_id_no}</div>
                    </div>
                    
                    <!-- Hover Action Buttons for SR/ID -->
                    <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-all duration-300 flex gap-2 z-20">
                        <button onclick="editSrId('${item.id}', '${item.sr_id_no}')" 
                                class="bg-blue-500 hover:bg-blue-600 text-white p-2 rounded-lg text-xs font-semibold transition-all shadow-lg hover:shadow-xl transform hover:scale-105 flex items-center gap-1">
                            <span>‚úèÔ∏è</span>
                            <span>Edit</span>
                        </button>
                        <button onclick="removeSrId('${item.id}')" 
                                class="bg-red-500 hover:bg-red-600 text-white p-2 rounded-lg text-xs font-semibold transition-all shadow-lg hover:shadow-xl transform hover:scale-105 flex items-center gap-1">
                            <span>üóëÔ∏è</span>
                            <span>Remove</span>
                        </button>
                    </div>
                </div>` : '';

            return `
                <div class="inventory-card bg-white rounded-2xl shadow-xl p-6 ${highlightClass} fade-in border border-gray-100 hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-1 relative group" data-item-id="${item.id}" style="background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);">
                    <!-- Header Section -->
                    <div class="flex justify-between items-start mb-6">
                        <div class="bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 text-white px-4 py-2 rounded-full text-xs font-black uppercase tracking-wider shadow-lg">
                            <span class="drop-shadow-sm">ID: ${item.id.slice(-8)}</span>
                        </div>
                        <div class="led-active-label">
                            ‚úÖ ACTIVE
                        </div>
                    </div>
                    
                    <!-- Card Action Buttons (Top Right Corner) -->
                    <div class="absolute top-4 right-4 opacity-0 group-hover:opacity-100 transition-all duration-300 flex gap-2 z-30">
                        <button onclick="editItem('${item.id}')" 
                                class="bg-blue-500 hover:bg-blue-600 text-white p-3 rounded-xl text-sm font-semibold transition-all shadow-lg hover:shadow-xl transform hover:scale-105 flex items-center gap-2">
                            <span>‚úèÔ∏è</span>
                            <span>Edit</span>
                        </button>
                        <button onclick="deleteItem('${item.id}')" 
                                class="bg-red-500 hover:bg-red-600 text-white p-3 rounded-xl text-sm font-semibold transition-all shadow-lg hover:shadow-xl transform hover:scale-105 flex items-center gap-2">
                            <span>üóëÔ∏è</span>
                            <span>Delete</span>
                        </button>
                    </div>
                    
                    <!-- Main Content Card -->
                    <div class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 p-6 rounded-2xl mb-6 border-2 border-blue-100 shadow-inner relative overflow-hidden">
                        <!-- Decorative Background Pattern -->
                        <div class="absolute top-0 right-0 w-32 h-32 bg-gradient-to-bl from-blue-200/30 to-transparent rounded-full -translate-y-16 translate-x-16"></div>
                        <div class="absolute bottom-0 left-0 w-24 h-24 bg-gradient-to-tr from-purple-200/30 to-transparent rounded-full translate-y-12 -translate-x-12"></div>
                        
                        <!-- Buyer Name Section -->
                        <div class="relative z-10">
                            <div class="mb-4">
                                <div class="text-xs text-blue-600 font-bold uppercase tracking-wide mb-1">Buyer Name</div>
                                <h3 class="text-2xl font-black text-gray-800 leading-tight">${item.buyer_name}</h3>
                            </div>
                            
                            <!-- Rack Location Section -->
                            <div class="bg-white/60 backdrop-blur-sm p-4 rounded-xl border border-white/50 shadow-sm">
                                <div class="text-xs text-emerald-600 font-bold uppercase tracking-wide">Rack Location</div>
                                <div class="font-black text-gray-800 text-xl">${item.rack_location}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- SR/ID Section -->
                    ${srIdDisplay}
                    
                    <!-- Date Section -->
                    <div class="bg-gradient-to-r from-slate-50 to-gray-50 p-4 rounded-xl mb-4 border border-slate-200 shadow-sm">
                        <div class="flex items-center gap-3">
                            <div class="bg-gradient-to-br from-slate-400 to-gray-500 p-2 rounded-lg shadow-md">
                                <span class="text-white text-sm">üìÖ</span>
                            </div>
                            <div class="text-sm text-slate-600 font-bold">
                                Added: ${new Date(item.created_at).toLocaleDateString('en-US', {
                                    year: 'numeric',
                                    month: 'short',
                                    day: 'numeric',
                                    hour: '2-digit',
                                    minute: '2-digit'
                                })}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Item management
        async function addItem(formData) {
            if (currentRecordCount >= 999) {
                showToast("Maximum limit of 999 items reached. Please delete some items first.", "error");
                return false;
            }

            const itemId = generateId();
            const itemData = {
                buyer_name: formData.buyerName,
                rack_location: formData.rackLocation,
                sr_id_no: formData.srIdNo || '',
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
            };

            try {
                await database.ref(`inventory/${itemId}`).set(itemData);
                showToast("‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá", "success");
                return true;
            } catch (error) {
                console.error("Error adding item:", error);
                showToast("‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶§‡ßá ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø", "error");
                return false;
            }
        }

        async function deleteItem(itemId) {
            // Show confirmation dialog
            if (!showConfirmDialog(`‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶Ø‡ßá ‡¶è‡¶á ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ‡¶ü‡¶ø ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?`)) {
                return;
            }

            try {
                await database.ref(`inventory/${itemId}`).remove();
                showToast("‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá", "success");
            } catch (error) {
                console.error("Error deleting item:", error);
                showToast("‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø", "error");
            }
        }

        // Edit item function
        async function editItem(itemId) {
            const item = inventoryData.find(i => i.id === itemId);
            if (!item) return;

            // Create edit modal
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full max-h-[90vh] overflow-y-auto">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="bg-blue-500 p-3 rounded-xl">
                            <span class="text-white text-2xl">‚úèÔ∏è</span>
                        </div>
                        <div>
                            <h3 class="text-2xl font-bold text-gray-800">Edit Item</h3>
                            <p class="text-gray-600">‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ‡ßá‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶∏‡¶Æ‡ßç‡¶™‡¶æ‡¶¶‡¶®‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®</p>
                        </div>
                    </div>
                    
                    <form id="edit-item-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">BUYER NAME *</label>
                            <input type="text" id="edit-buyer-name" value="${item.buyer_name}" required 
                                   class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none transition-colors text-lg font-medium">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">RACK LOCATION *</label>
                            <input type="text" id="edit-rack-location" value="${item.rack_location}" required 
                                   class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none transition-colors text-lg font-medium">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">SR/ID NO (Optional)</label>
                            <input type="text" id="edit-sr-id-no" value="${item.sr_id_no || ''}" 
                                   class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none transition-colors text-lg font-medium">
                        </div>
                        <div class="flex gap-3 pt-4">
                            <button type="submit" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-3 px-6 rounded-lg font-semibold flex items-center justify-center gap-2 transition-colors">
                                <span id="edit-btn-text">Save Changes</span>
                                <div id="edit-btn-spinner" class="loading-spinner hidden"></div>
                            </button>
                            <button type="button" onclick="closeEditModal()" class="px-6 py-3 bg-gray-500 hover:bg-gray-600 text-white rounded-lg font-semibold transition-colors">
                                Cancel
                            </button>
                        </div>
                    </form>
                </div>
            `;

            document.body.appendChild(modal);

            // Handle form submission
            document.getElementById('edit-item-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const submitBtn = document.getElementById('edit-btn-text');
                const spinner = document.getElementById('edit-btn-spinner');
                
                submitBtn.textContent = 'Saving...';
                spinner.classList.remove('hidden');
                
                const updatedItem = {
                    buyer_name: document.getElementById('edit-buyer-name').value,
                    rack_location: document.getElementById('edit-rack-location').value,
                    sr_id_no: document.getElementById('edit-sr-id-no').value,
                    updated_at: new Date().toISOString()
                };
                
                try {
                    await database.ref(`inventory/${itemId}`).update(updatedItem);
                    showToast("‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá", "success");
                    closeEditModal();
                } catch (error) {
                    console.error("Error updating item:", error);
                    showToast("‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø", "error");
                }
                
                submitBtn.textContent = 'Save Changes';
                spinner.classList.add('hidden');
            });

            // Focus first input
            setTimeout(() => {
                document.getElementById('edit-buyer-name').focus();
            }, 100);
        }

        // Edit SR/ID function
        async function editSrId(itemId, currentSrId) {
            const item = inventoryData.find(i => i.id === itemId);
            if (!item) return;

            // Create edit modal for SR/ID
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="bg-amber-500 p-3 rounded-xl">
                            <span class="text-white text-2xl">üè∑Ô∏è</span>
                        </div>
                        <div>
                            <h3 class="text-2xl font-bold text-gray-800">Edit SR/ID</h3>
                            <p class="text-gray-600">SR/ID ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶∏‡¶Æ‡ßç‡¶™‡¶æ‡¶¶‡¶®‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®</p>
                        </div>
                    </div>
                    
                    <form id="edit-srid-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">SR/ID NO</label>
                            <input type="text" id="edit-srid-input" value="${currentSrId}" 
                                   class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-amber-500 focus:outline-none transition-colors text-lg font-medium">
                        </div>
                        <div class="flex gap-3 pt-4">
                            <button type="submit" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-3 px-6 rounded-lg font-semibold flex items-center justify-center gap-2 transition-colors">
                                <span id="srid-btn-text">Save</span>
                                <div id="srid-btn-spinner" class="loading-spinner hidden"></div>
                            </button>
                            <button type="button" onclick="closeEditModal()" class="px-6 py-3 bg-gray-500 hover:bg-gray-600 text-white rounded-lg font-semibold transition-colors">
                                Cancel
                            </button>
                        </div>
                    </form>
                </div>
            `;

            document.body.appendChild(modal);

            // Handle form submission
            document.getElementById('edit-srid-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const submitBtn = document.getElementById('srid-btn-text');
                const spinner = document.getElementById('srid-btn-spinner');
                
                submitBtn.textContent = 'Saving...';
                spinner.classList.remove('hidden');
                
                try {
                    await database.ref(`inventory/${itemId}`).update({
                        sr_id_no: document.getElementById('edit-srid-input').value,
                        updated_at: new Date().toISOString()
                    });
                    showToast("SR/ID ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá", "success");
                    closeEditModal();
                } catch (error) {
                    console.error("Error updating SR/ID:", error);
                    showToast("SR/ID ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø", "error");
                }
                
                submitBtn.textContent = 'Save';
                spinner.classList.add('hidden');
            });

            // Focus input
            setTimeout(() => {
                document.getElementById('edit-srid-input').focus();
                document.getElementById('edit-srid-input').select();
            }, 100);
        }

        // Remove SR/ID function
        async function removeSrId(itemId) {
            if (!showConfirmDialog('‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶Ø‡ßá SR/ID ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶∏‡¶∞‡¶æ‡¶§‡ßá ‡¶ö‡¶æ‡¶®?')) {
                return;
            }

            try {
                await database.ref(`inventory/${itemId}`).update({
                    sr_id_no: '',
                    updated_at: new Date().toISOString()
                });
                showToast("SR/ID ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡¶∞‡¶æ‡¶®‡ßã ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá", "success");
            } catch (error) {
                console.error("Error removing SR/ID:", error);
                showToast("SR/ID ‡¶∏‡¶∞‡¶æ‡¶§‡ßá ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø", "error");
            }
        }

        // Close edit modal
        function closeEditModal() {
            const modal = document.querySelector('.fixed.inset-0.bg-black.bg-opacity-50');
            if (modal) {
                modal.remove();
            }
        }

        // Confirmation dialog function
        function showConfirmDialog(message) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full text-center">
                    <div class="text-6xl mb-4">‚ö†Ô∏è</div>
                    <h3 class="text-xl font-bold text-gray-800 mb-4">‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§‡¶ï‡¶∞‡¶£</h3>
                    <p class="text-gray-600 mb-6">${message}</p>
                    <div class="flex gap-3">
                        <button id="confirm-yes" class="flex-1 bg-red-600 hover:bg-red-700 text-white py-3 px-6 rounded-lg font-semibold transition-colors">
                            ‡¶π‡ßç‡¶Ø‡¶æ‡¶Å, ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§
                        </button>
                        <button id="confirm-no" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-3 px-6 rounded-lg font-semibold transition-colors">
                            ‡¶®‡¶æ, ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            return new Promise((resolve) => {
                document.getElementById('confirm-yes').addEventListener('click', () => {
                    modal.remove();
                    resolve(true);
                });
                
                document.getElementById('confirm-no').addEventListener('click', () => {
                    modal.remove();
                    resolve(false);
                });

                // Close on backdrop click
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                        resolve(false);
                    }
                });
            });
        }

        function generateId() {
            return 'item_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // Update total count display
        function updateTotalCount() {
            const totalCount = document.getElementById('total-count');
            if (totalCount) {
                totalCount.textContent = inventoryData.length;
            }
        }

        // UI utilities
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            
            // Enhanced styling based on type
            let toastClass, icon, bgGradient, shadowColor;
            
            switch(type) {
                case 'success':
                    toastClass = 'success-toast';
                    icon = '‚úÖ';
                    bgGradient = 'linear-gradient(135deg, #10b981, #059669, #047857)';
                    shadowColor = 'rgba(16, 185, 129, 0.4)';
                    break;
                case 'error':
                    toastClass = 'error-toast';
                    icon = '‚ùå';
                    bgGradient = 'linear-gradient(135deg, #ef4444, #dc2626, #b91c1c)';
                    shadowColor = 'rgba(239, 68, 68, 0.4)';
                    break;
                default:
                    toastClass = 'info-toast';
                    icon = '‚ÑπÔ∏è';
                    bgGradient = 'linear-gradient(135deg, #3b82f6, #2563eb, #1d4ed8)';
                    shadowColor = 'rgba(59, 130, 246, 0.4)';
            }
            
            toast.className = `fixed top-4 right-4 z-50 ${toastClass}`;
            toast.style.cssText = `
                background: ${bgGradient};
                color: white;
                padding: 16px 24px;
                border-radius: 16px;
                font-weight: 600;
                font-size: 15px;
                box-shadow: 
                    0 10px 25px ${shadowColor},
                    0 4px 12px rgba(0, 0, 0, 0.15),
                    0 0 0 1px rgba(255, 255, 255, 0.1);
                border: 2px solid rgba(255, 255, 255, 0.2);
                backdrop-filter: blur(10px);
                transform: translateX(100%);
                transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
                min-width: 300px;
                max-width: 400px;
            `;
            
            toast.innerHTML = `
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="
                        font-size: 24px;
                        animation: bounce 0.6s ease-in-out;
                        filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
                    ">${icon}</div>
                    <div style="flex: 1;">
                        <div style="
                            font-weight: 700;
                            margin-bottom: 2px;
                            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
                        ">${type === 'success' ? '‡¶∏‡¶´‡¶≤!' : type === 'error' ? '‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø!' : '‡¶§‡¶•‡ßç‡¶Ø'}</div>
                        <div style="
                            font-size: 14px;
                            opacity: 0.95;
                            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
                        ">${message}</div>
                    </div>
                    <div style="
                        width: 4px;
                        height: 40px;
                        background: rgba(255, 255, 255, 0.3);
                        border-radius: 2px;
                        animation: progress 3s linear;
                    "></div>
                </div>
            `;
            
            // Add keyframe animations
            if (!document.getElementById('toast-animations')) {
                const style = document.createElement('style');
                style.id = 'toast-animations';
                style.textContent = `
                    @keyframes bounce {
                        0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
                        40% { transform: translateY(-8px); }
                        60% { transform: translateY(-4px); }
                    }
                    @keyframes progress {
                        0% { height: 40px; opacity: 1; }
                        100% { height: 0px; opacity: 0.3; }
                    }
                    .success-toast:hover { transform: translateX(0) scale(1.02) !important; }
                    .error-toast:hover { transform: translateX(0) scale(1.02) !important; }
                    .info-toast:hover { transform: translateX(0) scale(1.02) !important; }
                `;
                document.head.appendChild(style);
            }
            
            document.body.appendChild(toast);
            
            // Slide in animation
            setTimeout(() => {
                toast.style.transform = 'translateX(0)';
            }, 100);
            
            // Auto remove with slide out animation
            setTimeout(() => {
                toast.style.transform = 'translateX(100%)';
                toast.style.opacity = '0';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.remove();
                    }
                }, 400);
            }, 3000);
            
            // Click to dismiss
            toast.addEventListener('click', () => {
                toast.style.transform = 'translateX(100%)';
                toast.style.opacity = '0';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.remove();
                    }
                }, 400);
            });
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            initializeSDK();
            
            // Navigation toggle
            document.getElementById('nav-toggle-btn').addEventListener('click', () => {
                const nav = document.getElementById('navigation-bar');
                nav.classList.toggle('hidden');
            });
            
            // Mode switching
            document.getElementById('user-mode-btn').addEventListener('click', () => switchMode('user'));
            document.getElementById('controller-mode-btn').addEventListener('click', () => showControllerAccess());
            document.getElementById('display-mode-btn').addEventListener('click', () => switchMode('display'));
            
            // Controller access
            document.getElementById('verify-code-btn').addEventListener('click', verifyControllerCode);
            document.getElementById('cancel-controller-btn').addEventListener('click', hideControllerAccess);
            
            // Access code input - Enter key support
            document.getElementById('access-code').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    verifyControllerCode();
                }
            });
            
            // Search and filter - Make sure it works in all modes
            document.getElementById('search-input').addEventListener('input', () => {
                applyFilters();
                renderInventory();
            });
            
            // Items per row control
            document.getElementById('items-per-row').addEventListener('change', (e) => {
                updateGridLayout(e.target.value);
                if (currentMode === 'controller') {
                    sendSyncCommand('grid_layout', { layout: e.target.value });
                }
            });
            
            document.getElementById('clear-search-btn').addEventListener('click', () => {
                document.getElementById('search-input').value = '';
                document.getElementById('item-type-filter').value = '';
                highlightedItems.clear();
                applyFilters();
                renderInventory();
                
                if (currentMode === 'controller') {
                    sendSyncCommand('clear_highlights', {});
                }
            });
            
            // User Add Item controls
            document.getElementById('user-add-item-btn').addEventListener('click', () => {
                document.getElementById('user-add-item-form').classList.toggle('hidden');
                if (!document.getElementById('user-add-item-form').classList.contains('hidden')) {
                    document.getElementById('user-buyer-name').focus();
                }
            });
            
            document.getElementById('user-cancel-add-btn').addEventListener('click', () => {
                document.getElementById('user-add-item-form').classList.add('hidden');
                document.getElementById('user-item-form').reset();
            });

            // Controller controls
            document.getElementById('add-item-btn').addEventListener('click', () => {
                document.getElementById('add-item-form').classList.toggle('hidden');
                if (!document.getElementById('add-item-form').classList.contains('hidden')) {
                    document.getElementById('buyer-name').focus();
                }
            });
            
            document.getElementById('cancel-add-btn').addEventListener('click', () => {
                document.getElementById('add-item-form').classList.add('hidden');
                document.getElementById('item-form').reset();
            });

            // Controller logout
            document.getElementById('controller-logout-btn').addEventListener('click', () => {
                logoutController();
            });
            
            document.getElementById('clear-highlights-btn').addEventListener('click', () => {
                document.getElementById('search-input').value = '';
                document.getElementById('item-type-filter').value = '';
                highlightedItems.clear();
                applyFilters();
                renderInventory();
                
                if (currentMode === 'controller') {
                    sendSyncCommand('clear_highlights', {});
                }
            });
            
            document.getElementById('scroll-top-btn').addEventListener('click', () => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
                
                if (currentMode === 'controller') {
                    sendSyncCommand('scroll_to_top', {});
                }
            });
            
            // User Form submission
            document.getElementById('user-item-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const submitBtn = document.getElementById('user-add-btn-text');
                const spinner = document.getElementById('user-add-btn-spinner');
                
                submitBtn.textContent = 'Adding...';
                spinner.classList.remove('hidden');
                
                const formData = {
                    buyerName: document.getElementById('user-buyer-name').value,
                    rackLocation: document.getElementById('user-rack-location').value,
                    srIdNo: document.getElementById('user-sr-id-no').value
                };
                
                const success = await addItem(formData);
                
                if (success) {
                    document.getElementById('user-item-form').reset();
                    document.getElementById('user-add-item-form').classList.add('hidden');
                }
                
                submitBtn.textContent = 'Add Item';
                spinner.classList.add('hidden');
            });

            // Controller Form submission
            document.getElementById('item-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const submitBtn = document.getElementById('add-btn-text');
                const spinner = document.getElementById('add-btn-spinner');
                
                submitBtn.textContent = 'Adding...';
                spinner.classList.remove('hidden');
                
                const formData = {
                    buyerName: document.getElementById('buyer-name').value,
                    rackLocation: document.getElementById('rack-location').value,
                    srIdNo: document.getElementById('sr-id-no').value
                };
                
                const success = await addItem(formData);
                
                if (success) {
                    document.getElementById('item-form').reset();
                    document.getElementById('add-item-form').classList.add('hidden');
                }
                
                submitBtn.textContent = 'Add Item';
                spinner.classList.add('hidden');
            });
            
            // Close navigation when clicking outside
            document.addEventListener('click', (e) => {
                const nav = document.getElementById('navigation-bar');
                const navBtn = document.getElementById('nav-toggle-btn');
                
                if (!nav.contains(e.target) && !navBtn.contains(e.target)) {
                    nav.classList.add('hidden');
                }
            });
        });
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'99ff01fe11f5ba4f',t:'MTc2MzM4MDE5OC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
    
  </body>
  
</html>
